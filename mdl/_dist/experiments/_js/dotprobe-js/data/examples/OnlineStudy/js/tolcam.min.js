function shuffle(t){for(var e,a,i=t.length;0!==i;)a=Math.floor(Math.random()*i),i-=1,e=t[i],t[i]=t[a],t[a]=e;return t}function loadWebgazer(){$("canvas").remove(),cam.initialized=0,$.getScript("js/webgazer.js").done(function(){initializeWebgazer(),$("#message").html("Please allow for access on your Webcam on the top part of the screen. <br /><br />Remember: We will NOT transmit your video, but only process it locally and transmit numbers to our server.").show()}).fail(function(){$("div.log").text("Triggered ajaxError handler.")})}function initializeWebgazer(){webgazer.clearData().setRegression("ridge").setTracker("clmtrackr").setGazeListener(function(e,a){if(null!==e){if(1==cam.calibrating){var i=$("#calibration_dot"),n=parseInt(Math.round(i.offset().left)),o=parseInt(Math.round(i.offset().top)),r=e,s=Math.sqrt((r.x-n)*(r.x-n)+(r.y-o)*(r.y-o)),l=$("#calibration_cnt").html();data_current.raw.push({time:a,x:r.x,y:r.y,cx:n,cy:o,dist:s,c:l})}if(1==cam.validating){var s=parseInt(Math.sqrt((e.x-validation_current.x)*(e.x-validation_current.x)+(e.y-validation_current.y)*(e.y-validation_current.y))),l=parseInt($("#calibration_cnt").html());s<validation.distance?(data_current.raw.push({time:a,x:e.x,y:e.y,vx:validation_current.x,vy:validation_current.y,dist:s,c:l,valid:1}),l<calibration.duration?$("#calibration_cnt").html(++l):(cam.validating=0,clearTimeout(t),$("#calibration_dot").hide(),validation_no++,saveData(),setTimeout("validate();",500))):data_current.raw.push({time:a,x:e.x,y:e.y,vx:validation_current.x,vy:validation_current.y,dist:s,c:l,valid:0})}if(1==cam.recording){var c=-1,d=-1;if("simple"==data_current.task||"pursuit"==data_current.task)var u=$("#stimuli_dot"),c=parseInt(Math.round(u.offset().left)),d=parseInt(Math.round(u.offset().top));data_current.raw.push({time:a,x:e.x,y:e.y,tx:c,ty:d,status:status})}}}).begin().showPredictionPoints(!1),cl=webgazer.getTracker().clm,checkWebgazer()}function checkWebgazer(){webgazer.isReady()?(console.log("webgazer is ready."),initializeCam()):setTimeout(checkWebgazer,100)}function initializeCam(){var t=document.getElementById("webgazerVideoFeed");t.style.display="block",t.style.position="relative",t.width=cam.width,t.height=cam.height,t.style.margin="0px",$("#webgazerVideoFeed").css({left:"50%",transform:"translate(-50%, 0)",margin:"20px"}).detach().insertAfter("#webcam_insert").get(0).play(),webgazer.params.imgWidth=cam.width,webgazer.params.imgHeight=cam.height,cam.overlay=document.getElementById("overlay"),null===cam.overlay&&(cam.overlay=document.createElement("canvas"),cam.overlay.id="overlay",document.body.appendChild(cam.overlay)),cam.overlay.style.position="absolute",cam.overlay.width=cam.width,cam.overlay.height=cam.height,cam.overlay.style.top=cam.topDist,cam.overlay.style.left=cam.leftDist,cam.overlay.style.margin="0px",cam.initialized=1,$("#message").html("Webcam access successful.").delay(1e3).fadeOut(1e3)}function prepareBlock(){1==cam.initialized?block_no<design.blocks.length?(trial_no=0,webgazer.resume(),1==design.recalibrate||0==block_no?($("#instruction_message").html(calibration.instruction).show(),setTimeout("$('#instruction_message').fadeOut(1000);",calibration.instruction_duration),setTimeout("startCalibration();",design.blocks[block_no].instruction_duration+2e3)):($("#instruction_message").html(design.blocks[block_no].instruction).show(),setTimeout("$('#instruction_message').fadeOut(1000);",design.blocks[block_no].instruction_duration),setTimeout("prepareTrial();",design.blocks[block_no].instruction_duration+2e3))):endExperiment():setTimeout("prepareBlock();",500)}function startCalibration(){$(".stimuli").hide(),$("#calibration_dot").hide(),0==block_no&&$("#calibration_dot").click(function(){calibrateHit()}),calibration_no=0,webgazer.clearData(),window.localStorage.clear(),t_calibration_start=(new Date).getTime(),calibrate()}function calibrate(){if(clearTimeout(t),calibration_no<calibration.calibrations){$("#calibration_cnt").html(calibration.duration),$c=$("#calibration_dot"),0==calibration.points.length&&(calibration.points=shuffle([{x:"20%",y:"20%"},{x:"50%",y:"20%"},{x:"80%",y:"20%"},{x:"20%",y:"50%"},{x:"50%",y:"50%"},{x:"80%",y:"50%"},{x:"20%",y:"80%"},{x:"50%",y:"80%"},{x:"80%",y:"80%"},{x:"35%",y:"35%"},{x:"65%",y:"35%"},{x:"35%",y:"65%"},{x:"65%",y:"65%"}]));var e=calibration.points.pop();$c.css({left:e.x,top:e.y}),data_current={type:"calibration",block:block_no,trial:calibration_no,x:e.x,y:e.y,raw:[]},cam.calibrating=1,$c.show(),"watch"==calibration.method&&(t=setTimeout("autoCalibration();",750))}else endCalibration()}function calibrateHit(){var e=$("#calibration_cnt").html();return e>1&&1==cam.calibrating?($("#calibration_cnt").html(--e),"watch"==calibration.method&&(t=setTimeout("autoCalibration();",100))):($("#calibration_cnt").html(9999),clearTimeout(t),cam.calibrating=0,$("#calibration_dot").hide(),calibration_no++,saveData(),calibrate()),!1}function autoCalibration(){calibrateLog(),1==cam.calibrating&&calibrateHit()}function calibrateLog(){var t=$("#calibration_dot"),e=parseInt(Math.round(t.offset().left)),a=parseInt(Math.round(t.offset().top));webgazer.watchListener(e,a)}function endCalibration(){clearTimeout(t),$("#calibration_dot").unbind("click"),startValidation()}function startValidation(){validation_no=0,validate()}function validate(){if(clearTimeout(t),validation_no<validation.validations){$("#calibration_cnt").html(0);var e=$("#calibration_dot");0==validation.points.length&&(validation.points=shuffle([{x:"20%",y:"20%"},{x:"80%",y:"20%"},{x:"50%",y:"50%"},{x:"20%",y:"80%"},{x:"80%",y:"80%"}]));var a=validation.points.pop();e.css({left:a.x,top:a.y}),e.show(),validation_current.x=Math.round(e.offset().left),validation_current.y=Math.round(e.offset().top),data_current={type:"validation",block:block_no,trial:validation_no,x:validation_current.x,y:validation_current.y,raw:[]},cam.validating=1,t=setTimeout("endValidation();",validation.timeout)}else endValidation()}function validateFail(){data_current.type="validationfail",data_current.attempt=validation_attempt,saveData(),cam.validating=0,webgazer.pause(),$(".stimuli").hide(),validation_attempt>=validation.attempts?$("#message").html('Unforuntately, the calibration failed too many times. Therefore, you can not participate in this study. Please contact <a href="mailto:kilian.semmelmann@rub.de">kilian.semmelmann@rub.de</a> if you have any questions. Thanks for your interest.').show():(validation_attempt++,$("#message").html("The calibration failed. <br />Please follow the instructions and try again (try "+validation_attempt+" of "+validation.attempts+").").show().delay(5e3).fadeOut(1e3),$("#instruction").show())}function endValidation(){cam.validating=0,validation_attempt=1,webgazer.pause(),$("#instruction_message").html(design.blocks[block_no].instruction).show(),setTimeout("$('#instruction_message').fadeOut(1000);",design.blocks[block_no].instruction_duration),setTimeout("prepareTrial();",design.blocks[block_no].instruction_duration+2e3)}function prepareTrial(){status="prepare",$(".stimuli").hide(),data_current={type:"trial",block:block_no,trial:trial_no,raw:[]},webgazer.resume(),startTrial()}function startTrial(){t_trial_start=(new Date).getTime(),$("#stimuli_fixation").show(),status="fixation_onset";var t=design.blocks[block_no].type+"Start";window[t]()}function endTrial(){clearTimeout(t),cam.recording=0,webgazer.pause(),status="end",$(".stimuli").hide(),trial_no++,saveData(),trial_no<design.blocks[block_no].trials?setTimeout("prepareTrial();",design.blocks[block_no].iti):(block_no++,block_no<design.blocks.length?(window.localStorage.clear(),webgazer.clearData(),navigation("pause")):endExperiment())}function saveData(){data.push(data_current),data_current={},sendData()}function sendData(){if(data.length>0){var t=data.shift();$.ajax({url:"process.php",type:"POST",data:{action:"save",type:t.type,data:t},tryCount:0,retryLimit:10,success:function(t){console.log(t),data.length>0&&sendData()},error:function(t){return this.tryCount++,this.tryCount<=this.retryLimit?void $.ajax(this):void console.log(t)}})}}function endExperiment(){webgazer.clearData().end(),$("#instruction").show(),page++,navigation("continue"),$.ajax({type:"POST",url:"endmail.php",data:{wat:"wat"}}),heatmap()}function simpleStart(){0==tSimple.positions.length&&(tSimple.positions=shuffle([{x:"20%",y:"20%"},{x:"50%",y:"20%"},{x:"80%",y:"20%"},{x:"20%",y:"50%"},{x:"80%",y:"50%"},{x:"20%",y:"80%"},{x:"50%",y:"80%"},{x:"80%",y:"80%"}]));var t=tSimple.positions.pop();$("#stimuli_dot").css({top:t.y,left:t.x}),data_current.task="simple",data_current.x=t.x,data_current.y=t.y,data_current.condition="dot_"+t.x+"_"+t.y,cam.recording=1,setTimeout('$("#stimuli_fixation").hide(); status = "fixation_offset";',1500),setTimeout("simpleShowdot();",2e3)}function simpleShowdot(){status="stimulus_onset",$("#stimuli_dot").show(),setTimeout('status = "stimulus_offset"; endTrial();',2e3)}function posnerStart(){var t=Math.random()>=.5?"&gt;&gt;&gt;":"&lt;&lt;&lt;";$("#stimuli_prime").html(t);var e=Math.random()>=.5?"X":"N";$("#stimuli_target").html(e);var a=Math.random()>=.7?"incongruent":"congruent",i="left";("incongruent"==a&&"&lt;&lt;&lt;"==t||"congruent"==a&&"&gt;&gt;&gt;"==t)&&(i="right");var n={};"left"==i?(n.x="20%",n.y="30%"):(n.x="80%",n.y="30%"),$("#stimuli_target").css({top:n.x,left:n.y}),data_current.task="posner",data_current.x=n.x,data_current.y=n.y,data_current.condition="posner_"+n.x+"_"+n.y+"_"+i,cam.recording=1,setTimeout("$('#stimuli_fixation').hide();",1e3),setTimeout("posnerShowprime();",1500)}function posnerShowprime(){$("#stimuli_prime").show(),setTimeout("posnerShowTarget();",300)}function posnerShowTarget(){$("#stimuli_prime").hide(),$("#stimuli_target").show(),setTimeout("endTrial();",1500)}function pursuitStart(){$("#stimuli_fixation").hide();var t=shuffle([{x:"20%",y:"20%",tx:"80%",ty:"20%"},{x:"20%",y:"20%",tx:"20%",ty:"80%"},{x:"20%",y:"20%",tx:"80%",ty:"80%"},{x:"80%",y:"20%",tx:"20%",ty:"20%"},{x:"80%",y:"20%",tx:"20%",ty:"80%"},{x:"80%",y:"20%",tx:"80%",ty:"80%"},{x:"20%",y:"80%",tx:"20%",ty:"20%"},{x:"20%",y:"80%",tx:"80%",ty:"20%"},{x:"20%",y:"80%",tx:"80%",ty:"80%"},{x:"80%",y:"80%",tx:"20%",ty:"20%"},{x:"80%",y:"80%",tx:"80%",ty:"20%"},{x:"80%",y:"80%",tx:"20%",ty:"80%"}]),e=t[0];$s=$("#stimuli_dot"),$s.css({top:e.y,left:e.x}),$s.css({"background-color":"#000"}),data_current.task="pursuit",data_current.x=e.x,data_current.y=e.y,data_current.condition="pursuit_"+e.x+"_"+e.y+"_"+e.tx+"_"+e.ty,cam.recording=1,$s.show(),setTimeout(function(){status="pursuit_start",$("#stimuli_dot").css({"background-color":"#dd494b"}).animate({left:e.tx,top:e.ty},2e3,"linear",function(){status="pursuit_end",setTimeout("endTrial();",500)})},1500)}function freeviewStart(){if(0==tFreeview.stimuli.length){for(var t=1;30>=t;t++)tFreeview.stimuli.push(10>t?"stimuli/tolcam_face_0"+t+".png":"stimuli/tolcam_face_"+t+".png");tFreeview.stimuli=shuffle(tFreeview.stimuli)}var e=tFreeview.stimuli.pop();$("#stimuli_fixation").css({top:"50%",left:"50%"});var a=Math.random()>=.5?"left":"right";$("#stimuli_img").css({left:"left"==a?"25%":"75%",width:"50%","background-image":"url("+e+")"}),data_current.task="freeviewing",data_current.x=$("#stimuli_img").css("left"),data_current.y="0%",data_current.condition="view_"+e+"_"+a,cam.recording=1,setTimeout("$('#stimuli_fixation').hide(); status = 'fixation_offset';",1e3),setTimeout("freeviewShow();",1500)}function freeviewShow(){status="stimulus_onset",$("#stimuli_img").show(),setTimeout("status = 'stimulus_offset'; endTrial();",3e3)}function heatmap(){for(var t=[],e=0;e<window.innerHeight;e++)for(var a=0;a<window.innerWidth;a++)t.push([a,e,0]);for(var i=0,n=0;n<data[data.length-1].raw.length;n++){var o=data[data.length-1].raw[n],r=Math.round(o.x),s=Math.round(o.y),l=s*window.innerWidth+r;l<=t.length&&l>=0?(t[l][2]+=1,t[l][2]>i&&(i=t[l][2])):console.log("dropped "+l)}for(var c=[],n=0;n<t.length;n++)0!=t[n][2]&&c.push(t[n]);$("body").append('<canvas id="heatmap"></canvas>'),$("#heatmap").attr("width",window.innerWidth),$("#heatmap").attr("height",window.innerHeight),heat=simpleheat("heatmap"),heat.resize(),heat.radius(30,50),heat.max(i).data(c).draw(),$("#stimuli_img").show()}function takePhoto(t){if("yes"==t){var e=document.getElementById("webgazerVideoCanvas"),a=e.toDataURL("image/jpeg");$.ajax({type:"POST",url:"photo.php",data:{imgBase64:a}})}$("#beforetherest").fadeOut(500,function(){$("#therest").fadeIn(500)})}function sendEmail(){$.ajax({type:"POST",url:"sendemail.php",data:{content:$("#emailtext").val()}}).success(function(){$("#message").html("Message sent.").fadeIn(500).delay(1e3).fadeOut(1e3),$("#emailtext").val("")}).error(function(){$("#message").html("ERROR: Message could not be sent.").fadeIn(500).delay(1e3).fadeOut(1e3)})}function navigation(t){if($("#message").hide(),$("#instruction_continue_text").html("&gt;"),2==page&&"continue"==t)$("#consent_y").prop("checked")?($("input[name='consent']").checkboxradio("disable"),$("input[name='consent']").checkboxradio("refresh"),d_consent=new Date,page++):$("#message").html("Please accept the consent form before continuing.").fadeIn(500).delay(1500).fadeOut(500);else if(3==page&&"continue"==t){var e=$("#f_birthday").val(),a=$("#f_gender").val(),i=$("#f_visual").val(),n="-",o=window.location.hash.substring(1);"cf"==o?n=""!=$("#f_crowdflowerid").val()?"cf_"+$("#f_crowdflowerid").val():"cf-":"rub"==o?n=""!=$("#f_rubid").val()?"rub_"+$("#f_rubid").val():"rub-":(n=""!=$("#f_asd").val()?"asd_"+$("#f_asd").val():"asd-",("asd_autism"==n||"asd_aspergers"==n||"asd_other"==n)&&(design.blocks=[{type:"freeview",trials:15,iti:500,instruction:"Please look at the cross.<br />An image will follow. You are free <br />to look at the image.<br /><br />Do not move your head, <br />only use your eyes.",instruction_duration:5e3},{type:"freeview",trials:15,iti:500,instruction:"Please look at the cross.<br />An image will follow. You are free <br />to look at the image.<br /><br />Do not move your head, <br />only use your eyes.",instruction_duration:5e3}],console.log(design.blocks))),void 0!==d_consent?""!=e&&""!=a&&""!=i?(data_current={type:"info",screen_width:window.innerWidth,screen_height:window.innerHeight,ua:navigator.userAgent,consent:d_consent,birthday:e,gender:a,visual:i,ident:n},saveData(),$("#instruction_continue_text").html("start"),page++):$("#message").html("Please fill out the form before continuing.").fadeIn(500).delay(1500).fadeOut(500):($("#message").html("Please accept the consent form, before continuing. ").fadeIn(500).delay(1500).fadeOut(500),$("#consent_n").prop("checked",!0),$("input[name='consent']").checkboxradio("enable"),$("input[name='consent']").checkboxradio("refresh"),page=2)}else 4==page&&"continue"==t?1==cam.initialized&&($("#instruction").fadeOut(1e3),setTimeout("prepareBlock();",2e3)):4==page&&"pause"==t?($("#instruction_continue").html("continue").css({"font-size":"1.7em"}),$("#instruction_4").find("h1").html("short pause (block "+block_no+" of "+design.blocks.length+")"),$("#setup_first").hide(),$("#setup_after").show(),$("#instruction").show(function(){block_no==design.blocks.length?page++:($("#instruction_4").fadeIn(300),$("#webgazerVideoFeed").show())})):"continue"==t?page++:"back"==t&&page--;page=1>page?1:page,page=page>$(".instruction_page").length?$(".instruction_page").length:page,1>=page?$("#instruction_back").hide():$("#instruction_back").show(),page>=$(".instruction_page").length?$("#instruction_continue").hide():$("#instruction_continue").show(),page>=5?$("#instruction_back,#instruction_continue").hide():"",block_no>0?$("#instruction_back").hide():"",oldpage!=page&&($(".instruction_page").hide(),$("#instruction_"+page).fadeIn(300)),4==page&&0==cam.initialized&&loadWebgazer(),oldpage=page}var cam={};cam.overlay="",cam.width=400,cam.height=300,cam.topDist="0px",cam.leftDist="0px",cam.recording=0,cam.validating=0,cam.calibrating=0,cam.initialized=0;var calibrating=0,t_calibration_start,calibration_no=0,calibration={};calibration.points=[],calibration.method="watch",calibration.calibrations=26,calibration.duration=20,calibration.instruction="Please fixate the dot<br />that will appear. <br /><br />Do not move your head,<br />only use your eyes.",calibration.instruction_duration=5e3;var validating=0,validation_no=0,validation_current={x:0,y:0},validation_attempt=1,validation={};validation.validations=5,validation.duration=20,validation.points=[],validation.timeout=2e4,validation.attempts=20,validation.distance=200;var design={},block_no=0,trial_no=0;design.blocks=[{type:"simple",trials:24,iti:500,instruction:"Please look at the cross.<br />When the dot appears, please look at it.<br /><br /><br />Do not move your head, <br />only use your eyes.",instruction_duration:5e3}],design.blocks=shuffle(design.blocks),design.blocks_randomized=1,design.trials_randomized=1,design.calibrate="high",design.recalibrate=1;var data=[],data_current={},status="-",t,t_trial_start,heat,tSimple={};tSimple.positions=[];var tPursuit={},tFreeview={};tFreeview.stimuli=[];var page=1,oldpage=-1,d_consent=void 0,cl,t_start=(new Date).getTime();$("document").ready(function(){$("#stimulus").hide(),$("#calibration_dot").hide(),$("#setup_after").hide(),$("#instruction_message").hide(),$("#therest").hide(),$("#start_button").click(function(){$(this).hide(),prepareBlock()}),$("body").keypress(function(t){t.keyCode}),$("#instruction_continue").click(function(){navigation("continue")}),$("#instruction_back").click(function(){navigation("back")}),$("#f_crowdflowerid").tooltip({show:{effect:"slideDown",delay:250}}),$("#takephoto_n").click(function(){takePhoto("no")}),$("#takephoto_y").click(function(){takePhoto("yes")}),$("#sendemail").click(function(){sendEmail()});for(var t=$("#f_birthday"),e=18;100>=e;e++)t.append('<option value="'+e+'">'+e+"</option>");window.localStorage.clear();var a=window.location.hash.substring(1);$("#cf_reference,#asd_reference,#rub_reference,#cf_code").hide(),"cf"==a?$("#cf_reference,#cf_code").show():"rub"==a?$("#rub_reference").show():$("#asd_reference").show();var i=navigator.userAgent.toLowerCase().indexOf("chrome")>-1,n=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;i||n?(page=0,navigation("start")):($("#instruction").hide(),$("#message").html('Thank you very much for your interest in our study.<br /><br />Unfortunately, your browser is not supported by our website. To participate, you need either the browser "Google Chrome" or "Firefox".<br /><br />Do download one of these securely and free of charge, please follow one of these links: <a href="https://www.google.com/chrome/browser/desktop/" target="_blank">Google Chrome</a> or <a href="https://www.mozilla.org/de/firefox/new/" target="_blank">Mozilla Firefox</a>').show())}),window.onbeforeunload=function(){};
//# sourceMappingURL=tolcam.min.js.map