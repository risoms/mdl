<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>mdl.eyetracking._roi &#8212; mdl-api 2019-05-14 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/semeon/css/user.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <script type="text/javascript" src="../../../_static/semeon/js/clipboard.js"></script>
    <script type="text/javascript" src="../../../_static/semeon/js/user.js"></script>
    <script type="text/javascript" src="../../../_static/semeon/js/copybutton.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../../../_static/imhr.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
	<meta charset='utf-8'>
	<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
	<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="description" content="Results from our feasibility study for in-browser eyetracking.">
	<meta name="author" content="Semeon Risom">
	<meta name="email" content="semeon.risom@gmail.com">
	<meta name="robots" content="index,follow">
	<meta name="AdsBot-Google" content="noindex">

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          mdl-api</a>
        <span class="navbar-text navbar-version pull-left"><b>2019-05-14</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../genindex.html">Glossary</a></li>
                <li><a href="../../../install.html">Install</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#dependencies">Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#installing">Installing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../install.html#testing">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#accesesing-raw-data">Accesesing Raw Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#preprocessing">Preprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#data-analysis">Data Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../features.html#relational-plots">Relational plots</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples/Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/R33/process_demographics.html">Process demographics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#get-metadata">get metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#prepare-data">prepare data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#demographic-statistics">demographic statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#list-of-variables">list of variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#descriptive-device">descriptive device</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#descriptive-task">descriptive task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_demographics.html#summary-data">summary data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/R33/download_data.html">Download data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/download_data.html#imports">imports</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/download_data.html#raw-data-(UTWeb)">raw data (UTWeb)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/download_data.html#REDCap">REDCap</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/download_data.html#box">box</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/R33/run_models.html">Run models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/R33/create_plots.html">Create plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/R33/process_data.html">Process data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_data.html#imports">imports</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/R33/process_data.html#start">start</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html">Eyetracking demo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Import-packages.">Import packages.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Set-task-parameters,-either-directly-from-PsychoPy-or-created-manually.">Set task parameters, either directly from PsychoPy or created manually.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Initialize-the-mdl.eyetracking-package.">Initialize the mdl.eyetracking package.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Connect-to-the-Eyelink-Host.">Connect to the Eyelink Host.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Set-the-dominamt-eye.">Set the dominamt eye.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Start-calibration.">Start calibration.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#(Optional)-Print-message-to-console/terminal.">(Optional) Print message to console/terminal.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#(Optional)-Drift-correction.">(Optional) Drift correction.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Start-recording.">Start recording.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Example-use-of-eyetracking.sample().">Example use of eyetracking.sample().</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Stop-recording.">Stop recording.</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/eyetracking/demo/eyetracking_demo.html#Close-PsychoPy.">Close PsychoPy.</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples/roi/generate_roi.html">Region of Interest</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#Read-ROI-from-photoshop-PSD-files">Read ROI from photoshop PSD files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#import-mdl-package">import mdl package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#set-path">set path</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#initiate">initiate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#start">start</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../examples/roi/generate_roi.html#results">results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/index.html">Current Data</a></li>
<li class="toctree-l1"><a class="reference external" href="http://localhost:8889/">Live Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dashboard.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/mdl.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/mdl.eyetracking.html">mdl.eyetracking</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/mdl.r33.html">mdl.r33</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/mdl.download.html">mdl.download</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/mdl.plot.html">mdl.plot</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../api/mdl.settings.html">mdl.settings</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples/Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/index.html">Current Data</a></li>
<li class="toctree-l1"><a class="reference external" href="http://localhost:8889/">Live Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dashboard.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/mdl.html">API Reference</a></li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
	<div class="imhr-bars">
		<div class="bar"></div>
		<div class="bar"></div>
		<div class="bar"></div>
		<div class="bar"></div>
	</div>
	<div class="row">
		<div class="toc col-md-3">
			<div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/index.html">Examples/Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/index.html">Current Data</a></li>
<li class="toctree-l1"><a class="reference external" href="http://localhost:8889/">Live Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dashboard.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/mdl.html">API Reference</a></li>
</ul>

			</div>
		</div>
		<div class="col-md-9 content">
			
  <h1>Source code for mdl.eyetracking._roi</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">| `@purpose`: Generate regions of interest that can be used for data processing and analysis.  </span>
<span class="sd">| `@date`: Created on Sat May 1 15:12:38 2019  </span>
<span class="sd">| `@author`: Semeon Risom  </span>
<span class="sd">| `@email`: semeon.risom@gmail.com  </span>
<span class="sd">| `@url`: https://semeon.io/d/mdl</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># allowed imports</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>

<span class="c1"># required external libraries</span>
<span class="n">__required__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;opencv-python&#39;</span><span class="p">,</span><span class="s1">&#39;psd-tools&#39;</span><span class="p">,</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span><span class="s1">&#39;Pillow&#39;</span><span class="p">]</span>

<span class="c1"># local</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">settings</span>

<span class="c1"># required for init</span>
<span class="kn">from</span> <span class="nn">pdb</span> <span class="k">import</span> <span class="n">set_trace</span> <span class="k">as</span> <span class="n">breakpoint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plot</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>

<span class="c1"># check if psd_tools and cv2 is available</span>
<span class="c1"># note: anaconda doesn&#39;t have a version of psd_tools or opencv-python (cv2) available (5/1/19), so a workaround </span>
<span class="c1"># when building is to directly install it.</span>
<span class="k">try</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">psd_tools</span>
	<span class="kn">import</span> <span class="nn">cv2</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
	<span class="kn">import</span> <span class="nn">importlib</span><span class="o">,</span> <span class="nn">sys</span>
	<span class="n">pkg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span>
	<span class="n">settings</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s2">&quot;No module named &#39;</span><span class="si">%s</span><span class="s2">&#39;. Installing from PyPI.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pkg</span><span class="p">),</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
	<span class="c1"># install</span>
	<span class="n">settings</span><span class="o">.</span><span class="n">library</span><span class="p">([</span><span class="n">pkg</span><span class="p">])</span>
	<span class="c1"># if not all packages are available, reload module</span>
	<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;cv2&#39;</span><span class="p">,</span><span class="s1">&#39;opencv-python&#39;</span><span class="p">],[</span><span class="s1">&#39;psd_tools&#39;</span><span class="p">,</span><span class="s1">&#39;psd-tools&#39;</span><span class="p">]]:</span>
		<span class="c1"># check if module is not available</span>
		<span class="k">if</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">find_spec</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">settings</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not available&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
			<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">])</span>
		<span class="c1"># import modules</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">settings</span><span class="o">.</span><span class="n">console</span><span class="p">((</span><span class="s1">&#39;import </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s1">&#39;blue&#39;</span><span class="p">))</span>
				<span class="nb">globals</span><span class="p">()[</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
				<span class="n">settings</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s2">&quot;import </span><span class="si">%s</span><span class="s2"> unsuccessful. Trying to install.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
				<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">])</span>

<div class="viewcode-block" id="ROI"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI">[docs]</a><span class="k">class</span> <span class="nc">ROI</span><span class="p">():</span>
	<span class="sd">&quot;&quot;&quot;Generate regions of interest that can be used for data processing and analysis.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="ROI.__init__"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.__init__">[docs]</a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isMultiprocessing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">image_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata_source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
			  <span class="n">roi_format</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">roicolumn</span><span class="o">=</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate the mdl.eyetracking.ROI module.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		isMultiprocessing : :obj:`bool`</span>
<span class="sd">			Should the rois be generated using multiprocessing. Default `False`.</span>
<span class="sd">		detection : :obj:`str`</span>
<span class="sd">			How should the regions of interest be detected. Either manually, through the use of highlight layers, or automatically</span>
<span class="sd">			using haar cascades opencv. Default `manual`.</span>
<span class="sd">		image_path : :obj:`str`</span>
<span class="sd">			Image directory path.</span>
<span class="sd">		output_path : :class:`str`</span>
<span class="sd">			Path to save data.</span>
<span class="sd">		roi_format : :obj:`str` {`raw`,`dataviewer`, `both`}</span>
<span class="sd">			Format to export ROIs. Either to &#39;csv&#39; (`raw`) or to Eyelink DataViewer &#39;ias&#39; (`dataviewer`) or both (`both`). </span>
<span class="sd">			Default is `raw`. Note: If :code:`roi_format` = `dataviewer`, :code:`shape` must be either be `circle`, `rotate`, or `straight`.</span>
<span class="sd">		metadata_source : :class:`str` or :obj:`None`</span>
<span class="sd">			Metadata source. If metadata is being read from a spreadsheet, :code:`metadata_source` should be equal to path the to</span>
<span class="sd">			the metadata file, else if metadata is embed within the image as a layer name, :code:`metadata_source` = `embedded`.</span>
<span class="sd">			Default is `embedded`. For example:</span>
<span class="sd">				&gt;&gt;&gt; # if metadata is in PSD images</span>
<span class="sd">				&gt;&gt;&gt; metadata = &#39;embedded&#39;</span>
<span class="sd">				&gt;&gt;&gt; # if metadata is an external xlsx file.</span>
<span class="sd">				&gt;&gt;&gt; metadata = &#39;roi/metadata.xlsx&#39;</span>
<span class="sd">			Although Photoshop PSD don&#39;t directly provide support for metadata. However if each region of interest is stored</span>
<span class="sd">			as a seperate layer within a PSD, the layer name can be used to store metadata. To do this, the layer name has</span>
<span class="sd">			to be written as delimited text. Our code can read this data and extract relevant metadata. The delimiter can</span>
<span class="sd">			be either `;` `,` `|` `\\t` or `\\s` (Delimiter type must be identified when running this code using the</span>
<span class="sd">			code:`delimiter` parameter. The default is `;`.). Here&#39;s an example using `;` as a delimiter:</span>
<span class="sd">				&gt;&gt;&gt; imagename=BM001;roiname=1;feature=lefteye</span>
<span class="sd">			Note: whitespace should be avoided from from each layer name. Whitespaces may cause errors during parsing.</span>
<span class="sd">		shape : :obj:`str` {`polygon`, `hull`, `circle`, `rotate`, `straight`}</span>
<span class="sd">			Shape of machine readable boundaries for region of interest. Default is `straight`. `polygon` creates a Contour</span>
<span class="sd">			Approximation and will most closely match the orginal shape of the roi. `hull` creates a Convex Hull, which</span>
<span class="sd">			is similar to but not as complex as a Contour Approximation and will include bulges for areas that are convex.</span>
<span class="sd">			`circle` creates a mininum enclosing circle. Finally, both `rotate` and `straight` create a Bounding Rectangle,</span>
<span class="sd">			with the only difference being compensation for the mininum enclosing area for the box when using `rotate`.</span>
<span class="sd">		roicolumn : :obj:`str`</span>
<span class="sd">			The name of the label for the region of interest in your metadata. For example you may want to extract the column</span>
<span class="sd">			&#39;feature&#39; from your metadata and use this as the label. Default is `roi`.</span>
<span class="sd">		uuid : :obj:`list` or :obj:`None`</span>
<span class="sd">			Create a unique id by combining a list of existing variables in the metadata. This is recommended</span>
<span class="sd">			if :code:`roi_format` == `dataviewer` because of the limited variables allowed for ias files. Default :obj:`None`.</span>
<span class="sd">		**kwargs : :obj:`str` or :obj:`None`, optional</span>
<span class="sd">			Additional properties. Here&#39;s a list of available properties:</span>

<span class="sd">			.. list-table::</span>
<span class="sd">				:class: kwargs</span>
<span class="sd">				:widths: 25 50</span>
<span class="sd">				:header-rows: 1</span>

<span class="sd">				* - Property</span>
<span class="sd">				  - Description</span>
<span class="sd">				* - **cores** : :class:`bool`</span>
<span class="sd">				  - (if :code:`isMultiprocessing` == `True`) Number of cores to use. Default is total available cores - 1.</span>
<span class="sd">				* - **isLibrary** : :class:`bool`</span>
<span class="sd">				  - Check if required packages have been installed. Default is :obj:`False`.</span>
<span class="sd">				* - **isDebug** : :class:`bool`</span>
<span class="sd">				  - Allow flags to be visible. Default is :obj:`False`.</span>
<span class="sd">				* - **isDemo** : :class:`bool`</span>
<span class="sd">				  - Tests code with in-house images and metadata. Default is :obj:`False`.</span>
<span class="sd">				* - **save_data** : :class:`bool`</span>
<span class="sd">				  - Save coordinates. Default is :obj:`True.`</span>
<span class="sd">				* - **newcolumn** : :class:`dict` {:obj:`str`, :obj:`str`} or :obj:`False`</span>
<span class="sd">				  - Add additional column to metadata. This must be in the form of a dict in this form {key: value}. </span>
<span class="sd">					Default is :obj:`False.`</span>
<span class="sd">				* - **save_raw_image** : :class:`bool`</span>
<span class="sd">				  - Save images. Default is True.</span>
<span class="sd">				* - **save_contour_image** : :class:`bool`</span>
<span class="sd">				  - Save generated contours as images. Default is :obj:`True`.</span>
<span class="sd">				* - **delimiter** : :class:`str`</span>
<span class="sd">				  - (if :code:`source` == `psd`) How is metadata delimited, options are: `;` `,` `|` `tab` or `space` Default is `;`.</span>
<span class="sd">				* - **screensize** : :class:`list` [:obj:`int`]</span>
<span class="sd">				  - Monitor size is being presented. Default is `[1920, 1080]`.</span>
<span class="sd">				* - **scale** : :class:`int`</span>
<span class="sd">				  - If image is scaled during presentation, set scale. Default is 1.</span>
<span class="sd">				* - **center** : :class:`list` [:obj:`int`]</span>
<span class="sd">				  - Center point of image, relative to screensize. Default is `[960, 540]`.</span>
<span class="sd">				* - **dpi** : :class:`int` or :obj:`None`</span>
<span class="sd">				  - (if :code:`save_image` == `True`) Quality of exported images, refers to &#39;dots per inch&#39;. Default is `300`.</span>

<span class="sd">		Attributes</span>
<span class="sd">		----------</span>
<span class="sd">		shape_d : :class:`str` {`ELLIPSE`, `FREEHAND`, `RECTANGLE`}</span>
<span class="sd">			DataViewer ROI shape.</span>
<span class="sd">		psd :  `psd_tools.PSDImage &lt;https://psd-tools.readthedocs.io/en/latest/reference/psd_tools.html#psd_tools.PSDImage&gt;`_</span>
<span class="sd">			Photoshop PSD/PSB file object. The file should include one layer for each region of interest.</span>
<span class="sd">		retval, threshold : :obj:`numpy.ndarray`</span>
<span class="sd">			Returns from :ref:`cv2.threshold`. The function applies a fixed-level thresholding to a multiple-channel array.</span>
<span class="sd">			`retval` provides an optimal threshold only if :ref:`cv2.THRESH_OTSU` is passed. `threshold` is an image after applying</span>
<span class="sd">			a binary threshold (:ref:`cv2.THRESH_BINARY`) removing all greyscale pixels &lt; 127. The output matches the same image</span>
<span class="sd">			channel as the original image.</span>
<span class="sd">			See `opencv &lt;https://docs.opencv.org/4.0.1/d7/d1b/group__imgproc__misc.html#gae8a4a146d1ca78c626a53577199e9c57&gt;`_ and</span>
<span class="sd">			`leanopencv &lt;https://www.learnopencv.com/opencv-threshold-python-cpp&gt;`_ for more information.</span>
<span class="sd">		contours, hierarchy : :obj:`numpy.ndarray`</span>
<span class="sd">			Returns from :ref:`cv2.findContours`. This function returns contours from the provided binary image (threshold).</span>
<span class="sd">			This is used here for later shape detection. `contours` are the detected contours, while hierarchy containing</span>
<span class="sd">			information about the image topology.</span>
<span class="sd">			See `opencv &lt;https://docs.opencv.org/4.0.1/d3/dc0/group__imgproc__shape.html#gadf1ad6a0b82947fa1fe3c3d497f260e07&gt;`_</span>
<span class="sd">			for more information.</span>
<span class="sd">		image_contours : :obj:`numpy.ndarray`</span>
<span class="sd">			Returns from :ref:`cv2.drawContours`. This draws filled contours from the image.</span>
<span class="sd">		image_contours : :obj:`numpy.ndarray`</span>
<span class="sd">			Returns from :ref:`cv2.drawContours`. This draws filled contours from the image.</span>

<span class="sd">		Raises</span>
<span class="sd">		------</span>
<span class="sd">		Exception</span>
<span class="sd">			[description]</span>
<span class="sd">		Exception</span>
<span class="sd">			[description]</span>

<span class="sd">		Examples</span>
<span class="sd">		--------</span>
<span class="sd">		&gt;&gt;&gt; from mdl.roi import ROI</span>
<span class="sd">		&gt;&gt;&gt; s=&quot;/dist/example/raw/&quot;; d=&quot;/dist/example/&quot;</span>
<span class="sd">		&gt;&gt;&gt; ROI(source=s, output_path=d, shape=&#39;box&#39;)</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		Resources</span>
<span class="sd">			- See https://docs.opencv.org/3.1.0/dd/d49/tutorial_py_contour_features.html for more information about each shape.</span>
<span class="sd">			- See https://docs.opencv.org/2.4/modules/core/doc/drawing_functions.html for more information about how images are drawn.</span>
<span class="sd">			- See https://docs.opencv.org/2.4/modules/imgproc/doc/structural_analysis_and_shape_descriptors.html to understand how bounds are created.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># get console and time</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">console</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">now</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">time</span>

		<span class="c1"># check debug</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;isDebug&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;isDebug&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">False</span>

		<span class="c1"># check library</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isLibrary</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;isLibrary&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;isLibrary&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isLibrary</span><span class="p">:</span>
			<span class="n">settings</span><span class="o">.</span><span class="n">library</span><span class="p">(</span><span class="n">__required__</span><span class="p">)</span>

		<span class="c1">#----parameters</span>
		<span class="c1"># demo</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isDemo</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;isDemo&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;isDemo&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">False</span>
		<span class="c1"># multiprocessing</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span> <span class="o">=</span> <span class="n">isMultiprocessing</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cores&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cores&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;max&#39;</span>
		<span class="c1"># if multiprocessing, set number of thread</span>
		<span class="c1"># if isMultiprocessing:</span>
		<span class="c1"># 	cv2.setNumThreads(0)</span>
		<span class="c1"># how to read data</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;metadata_source&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;metadata_source&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;embed&#39;</span>
		<span class="c1"># how to format rois</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">=</span> <span class="n">roi_format</span>
		<span class="c1"># delimiter</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;delimiter&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;delimiter&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">&#39;;&#39;</span>
		<span class="c1"># screensize</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">screensize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;screensize&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;screensize&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1920</span><span class="p">,</span> <span class="mi">1080</span><span class="p">]</span>
		<span class="c1"># scale</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">1</span>
		<span class="c1"># coordinates</span>
		<span class="n">cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
		<span class="n">cy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;coordinates&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">]</span>
		<span class="c1"># shape</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="k">if</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;hull&#39;</span><span class="p">,</span> <span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;straight&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;straight&#39;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#dataviewer shape</span>
		<span class="c1"># uuid</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">uuid</span>
		<span class="c1"># label</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">roicolumn</span> <span class="o">=</span> <span class="n">roicolumn</span>
		<span class="c1"># add column</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">newcolumn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;newcolumn&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;newcolumn&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">None</span>
		<span class="c1"># dpi</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dpi</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dpi&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;dpi&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="mi">300</span>
		<span class="c1"># save</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="c1"># save csv</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;save_data&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">True</span>
		<span class="c1"># save contour images</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">[</span><span class="s1">&#39;contours&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_contour_image&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;save_contour_image&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">True</span>
		<span class="c1"># save raw images</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;save_contour_image&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;save_contour_image&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="kc">True</span>

		<span class="c1">#----shape</span>
		<span class="c1"># check if trying to do complex ROI using dataviewer</span>
		<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;polygon&#39;</span><span class="p">,</span> <span class="s1">&#39;hull&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">==</span> <span class="s2">&quot;dataviewer&quot;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;Cannot use shape </span><span class="si">%s</span><span class="s2"> when exporting for DataViewer. </span><span class="se">\</span>
<span class="s2">					Please use either &#39;circle&#39;, &#39;rotate&#39;, or &#39;straight&#39; instead, or set roi_format == &#39;raw&#39;.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>

		<span class="c1">#----directory</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDemo</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">sys</span>
			<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">parent</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/raw/&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/output/&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
			<span class="n">metadata_source</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/metadata.xlsx&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">image_path</span> <span class="o">=</span> <span class="n">image_path</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
		<span class="c1"># set directory of files</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.psd&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_file</span><span class="p">()]</span>

		<span class="c1">#----read metadata file (if metadata is not None)</span>
		<span class="k">if</span> <span class="n">metadata_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;embedded&quot;</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span> <span class="o">=</span> <span class="n">metadata_source</span>
			<span class="n">_type</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
			<span class="k">if</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span><span class="p">)</span>
			<span class="k">elif</span> <span class="n">_type</span> <span class="o">==</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span><span class="p">)</span>

			<span class="c1"># check if metadata is empty</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No data for file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span><span class="p">))</span></div>

<div class="viewcode-block" id="ROI.process_metadata"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.process_metadata">[docs]</a>	<span class="k">def</span> <span class="nf">process_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">layer</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		imagename : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		layer : [type]</span>
<span class="sd">			[description]</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#----prepare metadata</span>
		<span class="c1"># if metadata is stored in image files directly</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_source</span> <span class="o">==</span> <span class="s1">&#39;embedded&#39;</span><span class="p">:</span>
			<span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">)),</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
			<span class="n">metadata</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
			<span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;roi&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
			<span class="n">roiname</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
			<span class="n">roilabel</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roicolumn</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

		<span class="c1"># else read metadata from file</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># get metadata</span>
			<span class="n">roiname</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\t\n\r</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># strip whitespace</span>
			<span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">imagename</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_all</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">roiname</span><span class="p">)]</span>
			<span class="c1"># if datafame empty</span>
			<span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
				<span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;No data for </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> (image:roi).&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">roiname</span><span class="p">)</span>
				<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">roilabel</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roicolumn</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

		<span class="c1"># print results</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;## roiname: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">roiname</span><span class="p">),</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;## roilabel: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">roilabel</span><span class="p">),</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">roiname</span><span class="p">,</span> <span class="n">roilabel</span></div>

<div class="viewcode-block" id="ROI.create_contours"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.create_contours">[docs]</a>	<span class="k">def</span> <span class="nf">create_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">roiname</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		image : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		imagename : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		roiname : [type]</span>
<span class="sd">			[description]</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>

<span class="sd">		Raises</span>
<span class="sd">		------</span>
<span class="sd">		Exception</span>
<span class="sd">			[description]</span>
<span class="sd">		Exception</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># convert pil image to grayscale (using pil)</span>
		<span class="c1">#self.console(&#39;test4.0.5&#39;, &#39;red&#39;)</span>
		<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>

		<span class="c1"># convert to np.array</span>
		<span class="c1">#self.console(&#39;test4.1.0&#39;, &#39;red&#39;)</span>
		<span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

		<span class="c1"># or convert pil image to grayscale (using cv2)</span>
		<span class="c1">#self.console(&#39;test4.1.5&#39;, &#39;red&#39;)</span>
		<span class="c1">#image = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</span>

		<span class="c1"># threshold the image</span>
		<span class="c1">## note: if any pixels that have value higher than 127, assign it to 255. convert to bw for countour and store original</span>
		<span class="c1">#self.console(&#39;test4.2&#39;, &#39;red&#39;)</span>
		<span class="n">retval</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>

		<span class="c1"># find contour in image</span>
		<span class="c1">#self.console(&#39;test4.3&#39;, &#39;red&#39;)</span>
		<span class="c1">## note: if you only want to retrieve the most external contour # use cv.RETR_EXTERNAL</span>
		<span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">RETR_EXTERNAL</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>

		<span class="c1"># if contours empty raise Exception</span>
		<span class="c1">#self.console(&#39;test4.4&#39;, &#39;red&#39;)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
			<span class="n">_err</span> <span class="o">=</span> <span class="p">[</span><span class="n">imagename</span><span class="p">,</span> <span class="n">roiname</span><span class="p">,</span> <span class="s1">&#39;Not able to identify contours&#39;</span><span class="p">]</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">; </span><span class="si">%s</span><span class="s1">; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">_err</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_err</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

		<span class="c1">#------------------------------------------------------------------------for each layer: save images and contours</span>
		<span class="c1">#when saving the contours below, only one drawContours function from above can be run</span>
		<span class="c1">#any other drawContours function will overlay on the others if multiple functions are run</span>
		<span class="c1">#----param</span>
		<span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
		<span class="c1">#self.console(&#39;test4.5&#39;, &#39;red&#39;)</span>

		<span class="c1">#----straight bounding box</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;straight&#39;</span><span class="p">:</span>
			<span class="c1"># self.console(&#39;## roishape: straight bounding box&#39;,&#39;green&#39;)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="s1">&#39;RECTANGLE&#39;</span> <span class="c1"># dataviewer shape</span>
			<span class="c1"># for each contour</span>
			<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="c1"># get bounds</span>
				<span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">,</span><span class="n">_w</span><span class="p">,</span><span class="n">_h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
				<span class="c1"># convert all coordinates floating point values to int</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)))</span>
				<span class="c1">#draw contours</span>
				<span class="n">roi_contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">pt1</span><span class="o">=</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">),</span> <span class="n">pt2</span><span class="o">=</span><span class="p">(</span><span class="n">_x</span><span class="o">+</span><span class="n">_w</span><span class="p">,</span><span class="n">_y</span><span class="o">+</span><span class="n">_h</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
			<span class="c1"># create bounds</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="n">roi_bounds</span>
			<span class="c1"># create contours</span>
			<span class="n">_contours</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">roi_contours</span><span class="p">])</span>

		<span class="c1">#----rotated bounding box</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;rotate&#39;</span><span class="p">:</span>
			<span class="c1"># self.console(&#39;## roishape: rotated bounding box&#39;,&#39;green&#39;)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="s1">&#39;FREEHAND&#39;</span> <span class="c1"># dataviewer shape</span>
			<span class="c1"># for each contour</span>
			<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="c1"># get bounds</span>
				<span class="n">rect</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
				<span class="c1"># convert all coordinates floating point values to int</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">roi_bounds</span><span class="p">)</span>
				<span class="c1">#draw contours</span>
				<span class="n">roi_contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="n">roi_bounds</span><span class="p">],</span> <span class="n">contourIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
			<span class="c1"># create bounds</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="n">roi_bounds</span>
			<span class="c1"># create contours</span>
			<span class="n">_contours</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">roi_contours</span><span class="p">])</span>

		<span class="c1">#----circle enclosing</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">:</span>
			<span class="c1"># self.console(&#39;## roishape: bounding circle&#39;,&#39;green&#39;)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="s1">&#39;ELLIPSE&#39;</span> <span class="c1"># dataviewer shape</span>
			<span class="c1"># for each contour</span>
			<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="c1"># get minimal enclosing circle</span>
				<span class="p">(</span><span class="n">_x</span><span class="p">,</span><span class="n">_y</span><span class="p">),</span><span class="n">_r</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minEnclosingCircle</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
				<span class="c1"># convert all coordinates floating point values to int</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int0</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">boxPoints</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">minAreaRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)))</span>
				<span class="c1">#get center and radius of circle</span>
				<span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_x</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">_y</span><span class="p">))</span>
				<span class="n">radius</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_r</span><span class="p">)</span>
				<span class="c1">#draw contours</span>
				<span class="n">roi_contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
			<span class="c1"># create bounds</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="n">roi_bounds</span>
			<span class="c1"># create contours</span>
			<span class="n">_contours</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">roi_contours</span><span class="p">])</span>

		<span class="c1">#----Contour Approximation</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;polygon&#39;</span><span class="p">:</span>
			<span class="c1"># self.console(&#39;## roishape: approximate polygon&#39;,&#39;green&#39;)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="s1">&#39;FREEHAND&#39;</span> <span class="c1"># dataviewer shape</span>
			<span class="c1"># for each contour</span>
			<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="n">epsilon</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">cv2</span><span class="o">.</span><span class="n">arcLength</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
				<span class="c1"># get approx polygons</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">approxPolyDP</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
				<span class="c1"># draw approx polygons</span>
				<span class="n">roi_contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="n">roi_bounds</span><span class="p">],</span> <span class="n">contourIdx</span><span class="o">=-</span><span class="mi">1</span> <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
			<span class="c1"># create bounds</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="n">roi_bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
			<span class="c1"># create contours</span>
			<span class="n">_contours</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">roi_contours</span><span class="p">])</span>

		<span class="c1">#----convex hull</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;hull&#39;</span><span class="p">:</span>
			<span class="c1"># self.console(&#39;## roishape: hull&#39;,&#39;green&#39;)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span> <span class="o">=</span> <span class="s1">&#39;FREEHAND&#39;</span> <span class="c1"># dataviewer shape</span>
			<span class="c1"># for each contour</span>
			<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">itm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contours</span><span class="p">):</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">contours</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
				<span class="c1"># get convex hull</span>
				<span class="n">roi_bounds</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convexHull</span><span class="p">(</span><span class="n">itm</span><span class="p">)</span>
				<span class="c1"># draw hull</span>
				<span class="n">roi_contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span><span class="n">contours</span><span class="o">=</span><span class="p">[</span><span class="n">roi_bounds</span><span class="p">],</span> <span class="n">contourIdx</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">FILLED</span><span class="p">)</span>
			<span class="c1"># create bounds</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="n">roi_bounds</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:]</span>
			<span class="c1"># create contours</span>
			<span class="n">_contours</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">roi_contours</span><span class="p">])</span>

		<span class="c1">#----no shape chosen</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Please select either straight, rotate, circle, polygon, box, or hull shape.&#39;</span><span class="p">)</span>

		<span class="c1">#self.console(&#39;test4.6&#39;, &#39;red&#39;)</span>

		<span class="k">return</span> <span class="n">_bounds</span><span class="p">,</span> <span class="n">_contours</span></div>

<div class="viewcode-block" id="ROI.create_rois"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.create_rois">[docs]</a>	<span class="k">def</span> <span class="nf">create_rois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">roiname</span><span class="p">,</span> <span class="n">roinumber</span><span class="p">,</span> <span class="n">_bounds</span><span class="p">,</span> <span class="n">_contours</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		imagename : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		metadata : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		roiname : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		roinumber : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		roilabel : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		_bounds : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		_contours : [type]</span>
<span class="sd">			[description]</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>

<span class="sd">		Raises</span>
<span class="sd">		------</span>
<span class="sd">		Exception</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#----store bounds as df</span>
		<span class="n">_bounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">_bounds</span><span class="p">)</span>

		<span class="c1"># transpose bounds (x0, y0, x1, y1)</span>
		<span class="n">_x</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
		<span class="n">_y</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

		<span class="c1"># check if bounding box has two x and y coordinate pairs</span>
		<span class="k">if</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="s1">&#39;straight&#39;</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s2">&quot;Error creating bounding box for image:roi </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">roiname</span><span class="p">))</span>

		<span class="c1"># set as df</span>
		<span class="n">bounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>

		<span class="c1"># rename</span>
		<span class="n">bounds</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span>

		<span class="c1"># add index, image, roi, and shape</span>
		<span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imagename</span>
		<span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;roi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roiname</span>
		<span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">roinumber</span>
		<span class="n">bounds</span><span class="p">[</span><span class="s1">&#39;shape_d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_d</span>

		<span class="c1"># clean-up</span>
		<span class="c1">## convert to int</span>
		<span class="n">bounds</span><span class="p">[[</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;y1&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">bounds</span><span class="p">[[</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;y1&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

		<span class="c1">#----save image:roi level image bounds and con</span>
		<span class="c1">#----save roi contours</span>
		<span class="c1">#!! get working: draw exact contours as coordinates</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">[</span><span class="s1">&#39;contours&#39;</span><span class="p">]:</span>
			<span class="n">contours</span> <span class="o">=</span> <span class="n">_contours</span>
		<span class="c1"># combine metadata with coordinates</span>
		<span class="c1">##!!! get working</span>

		<span class="c1">#----save roi df</span>
		<span class="c1"># combine metadata with bounds</span>
		<span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">bounds</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="s1">&#39;roi&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

		<span class="c1"># finish</span>
		<span class="k">return</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">contours</span></div>

<div class="viewcode-block" id="ROI.export_data"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.export_data">[docs]</a>	<span class="k">def</span> <span class="nf">export_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newcolumn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		df : [type]</span>
<span class="sd">			Bounds.</span>
<span class="sd">		path : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		filename : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		uuid : [type], optional</span>
<span class="sd">			[description], by default None</span>
<span class="sd">		newcolumn : [type], optional</span>
<span class="sd">			[description], by default None</span>
<span class="sd">		nested : :obj:`string` {`image`,`all`}</span>
<span class="sd">			Nested order, either `image` or `all`. Default `image`.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">#if workng with a single image</span>
		<span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
			<span class="c1"># if new column is not None and level == image</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">newcolumn</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,))):</span>
				<span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">newcolumn</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newcolumn</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

			<span class="c1"># if uuid, create a unique column</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,)):</span>
				<span class="n">df</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">uuid_column</span> <span class="o">=</span> <span class="s1">&#39;uuid&#39;</span>
			<span class="c1"># else simply use roiname</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">uuid_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roicolumn</span>

		<span class="c1">#else if workng with all images</span>
		<span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
			<span class="c1"># if uuid, create a unique column</span>
			<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,)):</span>
				<span class="n">uuid_column</span> <span class="o">=</span> <span class="s1">&#39;uuid&#39;</span>
			<span class="c1"># else simply use roiname</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">uuid_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roicolumn</span>

		<span class="c1"># check if folder exists</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

		<span class="c1"># export to excel</span>
		<span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">)):</span>
			<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.xlsx&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
			<span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

			<span class="c1"># if debug</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s2">&quot;## raw data saved @: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

		<span class="c1"># export to ias (dataviewer)</span>
		<span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">==</span> <span class="s1">&#39;dataviewer&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roi_format</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">)):</span>
			<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">.ias&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
			<span class="n">_bounds</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">[</span>
				<span class="s2">&quot;# EyeLink Interest Area Set created on </span><span class="si">%s</span><span class="s2">.&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
				<span class="s2">&quot;# Interest area set file using mdl.roi.ROI()&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# columns: RECTANGLE | IA number | x0 | y0 | x1 | y1 | label | color&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# columns: ELLIPSE | IA number | x0 | y0 | x1 | y1 | label | color&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# columns: FREEHAND | IA number | x0,y0 | x1,y1 | x2,y2 | x3,y3 | label | color&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# example: RECTANGLE 1 350 172 627 286 leftcheek red&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# example: ELLIPSE 2 350 172 627 286 leftcheek red&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# example: FREEHAND 3 350,172 627,172 627,286 350,286 leftcheek red&quot;</span><span class="p">,</span>
				<span class="s2">&quot;# See Section 5.10.1 of Eyelink DataViewer Users Manual (3.2.1) for more information.&quot;</span><span class="p">,</span>
				<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;shape_d&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;y1&#39;</span><span class="p">,</span><span class="n">uuid_column</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;	&#39;</span><span class="p">)</span>
			<span class="p">]))</span>
			<span class="c1"># save to ias</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
				<span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_bounds</span><span class="p">)</span>

			<span class="c1"># if debug</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s2">&quot;## dataviewer data saved @: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="ROI.draw_image"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.draw_image">[docs]</a>	<span class="k">def</span> <span class="nf">draw_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;bounds&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		imagename : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		data : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		source : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># draw image</span>
		<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
		<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
		<span class="c1">## create blank image and draw to figure</span>
		<span class="n">_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">_img</span><span class="p">)</span>
		<span class="c1">## for each bound draw on figure</span>
		<span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s2">&quot;bounds&quot;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">_bounds</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="c1">## get bounds</span>
				<span class="n">x0</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
				<span class="n">y0</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
				<span class="n">x1</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
				<span class="n">y1</span> <span class="o">=</span> <span class="n">_bounds</span><span class="p">[</span><span class="s1">&#39;y1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
				<span class="n">_width</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span>
				<span class="n">_height</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span>
				<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patches</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">),</span> <span class="n">_width</span><span class="p">,</span> <span class="n">_height</span><span class="p">))</span>
			<span class="c1">## draw image</span>
			<span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/img/roi/bounds&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
		<span class="c1">## for each contour draw on figure</span>
		<span class="k">elif</span> <span class="n">source</span><span class="o">==</span><span class="s2">&quot;contours&quot;</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">_contours</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
				<span class="n">contours</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">_contours</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
				<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
			<span class="c1">## draw image</span>
			<span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/img/roi/contours&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
		<span class="c1">## check folder</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_folder</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_folder</span><span class="p">)</span>
		<span class="c1">## save</span>
		<span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">_folder</span><span class="p">,</span> <span class="n">imagename</span><span class="p">))</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;## image saved @: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">filepath</span><span class="p">),</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
		<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="ROI.process_image"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.process_image">[docs]</a>	<span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psd</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		psd :  `psd_tools.PSDImage &lt;https://psd-tools.readthedocs.io/en/latest/reference/psd_tools.html#psd_tools.PSDImage&gt;`_</span>
<span class="sd">			Photoshop PSD/PSB file object. The file should include one layer for each region of interest.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1">## load image directly from PSD</span>
		<span class="n">image</span> <span class="o">=</span> <span class="n">psd</span><span class="o">.</span><span class="n">topil</span><span class="p">()</span>

		<span class="c1"># scale image</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">_truesize</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
			<span class="n">_scalesize</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">_truesize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">_truesize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)]</span>
			<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">_scalesize</span><span class="p">,</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> 
				<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;# export image&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;size: </span><span class="si">%s</span><span class="s1">, scaled: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">_truesize</span><span class="p">,</span> <span class="n">_scalesize</span><span class="p">),</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

		<span class="c1"># center and resize image to template screen</span>
		<span class="n">background</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">screensize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">background</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">background</span></div>

<div class="viewcode-block" id="ROI.run"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.run">[docs]</a>	<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		directory : :obj:`list`</span>
<span class="sd">			[description]</span>
<span class="sd">		core : :obj:`int`</span>
<span class="sd">			(if isMultiprocessing) Core used for this function. Default `0`.</span>
<span class="sd">		queue : :obj:`queue.Queue`</span>
<span class="sd">			Constructor for a multiprocessing &#39;first-in, first-out&#39; queue. Note: Queues are thread and process safe.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="c1">#----prepare lists for all images</span>
		<span class="n">l_bounds_all</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">l_contours_all</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">l_error</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="c1">#!!!----for each image</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;starting()&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;for each image&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">directory</span><span class="p">:</span>
			<span class="c1"># console</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;core: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">core</span><span class="p">),</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>

			<span class="c1"># read image</span>
			<span class="n">psd</span> <span class="o">=</span> <span class="n">psd_tools</span><span class="o">.</span><span class="n">PSDImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
			<span class="n">imagename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">imagename</span><span class="p">),</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

			<span class="c1"># clear lists</span>
			<span class="n">l_bounds</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#list of bounds</span>
			<span class="n">l_contours</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#list of contours</span>

			<span class="c1">#!!!----for each image, save image file</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]:</span>
				<span class="c1">#self.console(&#39;test&#39;)</span>
				<span class="c1"># process imaage</span>
				<span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_image</span><span class="p">(</span><span class="n">psd</span><span class="o">=</span><span class="n">psd</span><span class="p">)</span>

				<span class="c1"># check folder</span>
				<span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/img/&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
				<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_folder</span><span class="p">):</span>
					<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_folder</span><span class="p">)</span>

				<span class="c1"># figure</span>
				<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
				<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.png&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">_folder</span><span class="p">,</span> <span class="n">imagename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
				<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
				<span class="c1">#self.console(&#39;test1&#39;, &#39;red&#39;)</span>

			<span class="c1">#!!!----for each region of interest</span>
			<span class="c1">## counter</span>
			<span class="n">roinumber</span> <span class="o">=</span> <span class="mi">1</span>
			<span class="c1">## create matplotlib plot()</span>
			<span class="c1">## do for each roi</span>
			<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">psd</span><span class="p">:</span>
				<span class="c1"># skip if layer is main image</span>
				<span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">==</span> <span class="n">imagename</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="c1"># process metadata</span>
					<span class="c1">#self.console(&#39;test2&#39;, &#39;red&#39;)</span>
					<span class="n">metadata</span><span class="p">,</span> <span class="n">roiname</span><span class="p">,</span> <span class="n">roilabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_metadata</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

					<span class="c1"># process image</span>
					<span class="c1">#self.console(&#39;test3&#39;, &#39;red&#39;)</span>
					<span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_image</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

					<span class="c1"># create contours</span>
					<span class="c1">#self.console(&#39;test4&#39;, &#39;red&#39;)</span>
					<span class="n">_bounds</span><span class="p">,</span> <span class="n">_contours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_contours</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">roiname</span><span class="p">)</span>

					<span class="c1"># create rois</span>
					<span class="n">bounds</span><span class="p">,</span> <span class="n">contours</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_rois</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">roiname</span><span class="p">,</span> <span class="n">roinumber</span><span class="p">,</span> <span class="n">_bounds</span><span class="p">,</span> <span class="n">_contours</span><span class="p">)</span>

					<span class="c1"># try:</span>
					<span class="c1"># 	#self.console(&#39;test5&#39;, &#39;red&#39;)</span>

					<span class="c1"># except Exception as e:</span>
					<span class="c1"># 	# error</span>
					<span class="c1"># 	print(e)</span>
					<span class="c1"># 	#store error</span>
					<span class="c1"># 	l_error.append([imagename, roiname, e]) # &lt;image&gt;&lt;roi&gt;&lt;error message&gt;</span>
					<span class="c1"># 	# continue to next image</span>
					<span class="c1"># 	break</span>

					<span class="c1"># store processed bounds and contours to combine across image</span>
					<span class="n">l_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
					<span class="n">l_contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contours</span><span class="p">)</span>

					<span class="c1"># update counter</span>
					<span class="n">roinumber</span> <span class="o">=</span> <span class="n">roinumber</span> <span class="o">+</span> <span class="mi">1</span>

			<span class="c1">#!!!----for each image, export data</span>
			<span class="c1"># draw bounds</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">draw_image</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">l_bounds</span><span class="p">,</span> <span class="s1">&#39;bounds&#39;</span><span class="p">)</span>
			<span class="c1"># draw contours</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">draw_image</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">l_contours</span><span class="p">,</span> <span class="s1">&#39;contours&#39;</span><span class="p">)</span>

			<span class="c1"># concatinate and store bounds for all rois</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">l_bounds</span><span class="p">)</span>
			<span class="n">l_bounds_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

			<span class="c1"># export data</span>
			<span class="n">_filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_bounds&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
			<span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/data/&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_folder</span><span class="p">):</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">_folder</span><span class="p">)</span>
			<span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">_folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">_filename</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">newcolumn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">newcolumn</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">)</span>

			<span class="c1"># contours</span>
			<span class="c1">##!!! create roi file for complex shapes (not with dataviewer)</span>

		<span class="c1">#!!!----finished for all images</span>
		<span class="c1"># store</span>
		<span class="c1">## if multiprocessing, store in queue</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span><span class="p">:</span>
			<span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">l_bounds_all</span><span class="p">)</span>
			<span class="k">pass</span>
		<span class="c1"># if not multiprocessing, return</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">l_bounds_all</span><span class="p">,</span> <span class="n">l_contours_all</span><span class="p">,</span> <span class="n">l_error</span></div>

<div class="viewcode-block" id="ROI.process"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.process">[docs]</a>	<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;[summary]</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>
<span class="sd">		[type]</span>
<span class="sd">			[description]</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># prepare arguements and procedure</span>
		<span class="n">df</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

		<span class="c1"># if multiprocessing, get total cores</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">multiprocessing</span>

			<span class="c1">#----get number of available cores</span>
			<span class="n">_max</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

			<span class="c1">#---check if selected max or value above possible cores</span>
			<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">&gt;=</span> <span class="n">_max</span><span class="p">):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">_max</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span>

			<span class="c1">#----double check multiproessing</span>
			<span class="c1"># if requested cores is 0 or 1, run without multiprocessing</span>
			<span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span> <span class="o">=</span> <span class="kc">False</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;not multiprocessing&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">)</span>
			<span class="c1"># split directory by number of cores</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="n">l_directory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;multiprocessing with </span><span class="si">%s</span><span class="s1"> cores&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">),</span> <span class="s1">&#39;purple&#39;</span><span class="p">)</span>

		<span class="c1"># not multiprocessing</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span> <span class="o">=</span> <span class="kc">False</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;not multiprocessing&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">)</span>

		<span class="c1">#----prepare to run</span>
		<span class="c1"># if not multiprocessing</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span><span class="p">:</span>
			<span class="n">l_bounds_all</span><span class="p">,</span> <span class="n">l_contours_all</span><span class="p">,</span> <span class="n">l_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

			<span class="c1"># finish</span>
			<span class="n">df</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">l_bounds_all</span><span class="p">)</span>

		<span class="c1"># else if multiprocessing</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="c1"># collect each pipe (this is used to build send and recieve portions of output)</span>
			<span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

			<span class="c1"># prepare threads</span>
			<span class="n">process</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">l_directory</span><span class="p">[</span><span class="n">core</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">core</span><span class="p">,</span> <span class="n">queue</span><span class="p">,))</span> <span class="k">for</span> <span class="n">core</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cores</span><span class="p">)]</span>

            <span class="c1"># start each thread</span>
			<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">process</span><span class="p">:</span>
				<span class="n">p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
				<span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

			<span class="c1"># return pipes</span>
            <span class="c1"># note: see https://stackoverflow.com/a/45829852</span>
			<span class="n">returns</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">process</span><span class="p">:</span>
				<span class="n">returns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>

			<span class="c1"># wait for each process to finish</span>
			<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">process</span><span class="p">:</span>
				<span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

			<span class="c1">#----after running</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isDebug</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;process() finished (multiprocessing)&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
			<span class="n">df</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">error</span></div>

<div class="viewcode-block" id="ROI.finished"><a class="viewcode-back" href="../../../api/mdl.eyetracking._roi.html#mdl.eyetracking.ROI.finished">[docs]</a>	<span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Process bounds for all images.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		df : [type]</span>
<span class="sd">			[description]</span>
<span class="sd">		errors : [type], optional</span>
<span class="sd">			[description], by default None</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="c1"># if multiprocessing, combine df from each thread</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isMultiprocessing</span><span class="p">:</span>
			<span class="c1">#concat data</span>
			<span class="n">df</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="c1">#check if lists are empty (i.e. if there are more threads than directories)</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
		<span class="c1"># else combine lists of df to df</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

		<span class="c1">#!!!----combine all rois across images</span>
		<span class="c1"># export to csv or dataviewer</span>
		<span class="n">_folder</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">)</span>
		<span class="n">_filename</span> <span class="o">=</span> <span class="s2">&quot;bounds&quot;</span>
		<span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">_folder</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">_filename</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

		<span class="c1">#!!!----error log</span>
		<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
			<span class="n">_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/error.csv&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">))</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s2">&quot;Errors found. See log </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">_filename</span><span class="p">),</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">,</span><span class="s1">&#39;roi&#39;</span><span class="p">,</span><span class="s1">&#39;message&#39;</span><span class="p">])</span>
			<span class="n">error</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">_filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>

		<span class="c1"># finished</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">(</span><span class="s1">&#39;finished()&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">error</span></div></div>

<span class="c1">#%% test</span>
<span class="c1"># drawing image</span>
<span class="c1"># img = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)</span>
<span class="c1"># cv2.imshow(&#39;image&#39;,img)</span>

<span class="c1"># convert img to np array</span>
<span class="c1"># np_img = np.array(img)</span>
</pre></div>

		</div>
		  
	</div>
</div>
<footer class="footer">
	<div class="container">
		<div>
					<div>&copy; Copyright 2019, </div>
			<div><a href="https://semeon.io/">Semeon Risom</a>.</div>
				<div>Updated 2019-05-14T13:51:19-05:00.</div>
		</div>
	</div>
</footer>
  </body>
</html>